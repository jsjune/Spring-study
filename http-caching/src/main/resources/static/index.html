<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cache-Control Test</title>
</head>
<body>
<script>
    let cachedData = null;
    let cachedEtag = null;
    let cachedTimestamp = null;

    async function createData() {
        const productName = document.getElementById("createProductName").value.trim();
        const quantity = document.getElementById("createQuantity").value.trim();

        if (!productName || !quantity) {
            alert("ìƒí’ˆëª…ê³¼ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const requestData = {
            productName: productName,
            quantity: parseInt(quantity, 10)
        };

        const response = await fetch(`/api/data`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData)
        });

        if (response.ok) {
            const data = await response.text();
            document.getElementById("output").innerText = `âœ… ë°ì´í„° ìƒì„± ì™„ë£Œ! ID: ${data}`;
        } else {
            document.getElementById("output").innerText = "âŒ ë°ì´í„° ìƒì„± ì‹¤íŒ¨!";
        }
    }

    async function fetchData() {
        const orderId = document.getElementById("orderId").value.trim();
        if (!orderId) {
            alert("IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const headers = {};
        const now = Date.now();
        const cacheMaxAge = 10 * 1000;

        // ìºì‹± ê¸°ê°„ì´ ì§€ë‚˜ì§€ ì•Šì•˜ë‹¤ë©´ ETagë¥¼ í¬í•¨
        if (cachedEtag && cachedTimestamp && (now - cachedTimestamp < cacheMaxAge)) {
            headers['If-None-Match'] = cachedEtag;
        } else {
            console.warn("âš  ìºì‹± ê¸°ê°„ì´ ì´ˆê³¼ë˜ì–´ ETagë¥¼ ì „ì†¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }

        const response = await fetch(`/api/data/${orderId}`, {headers});
        const etag = response.headers.get('ETag');

        if (response.status === 304) {
            document.getElementById('output').innerText = `ğŸ“¥ ìºì‹œëœ ë°ì´í„°: ${cachedData}`;
            return;
        }

        if (response.ok) {
            const data = await response.text();
            cachedData = data;
            cachedEtag = etag;
            document.getElementById('output').innerText = `ğŸ“¥ ìµœì‹  ë°ì´í„°: ${data}`;
        }
    }


    async function updateData() {
        const orderId = document.getElementById("updateOrderId").value.trim();
        if (!orderId) {
            alert("IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        const newProductName = document.getElementById("updateProductName").value.trim();
        const newQuantity = document.getElementById("updateQuantity").value.trim();

        const updatedData = {
            productName: newProductName,
            quantity: parseInt(newQuantity, 10)
        };
        await fetch(`/api/data/${orderId}`, {
            method: 'PUT' ,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updatedData)
        });
        document.getElementById('output').innerText = 'âœ ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ "ë°ì´í„° ê°€ì ¸ì˜¤ê¸°"ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”!';
    }
</script>
<h1>ETag + Cache-Control í…ŒìŠ¤íŠ¸</h1>

<h2>ğŸ“Œ ë°ì´í„° ìƒì„±</h2>
<label for="createProductName">ìƒí’ˆëª…: </label>
<input type="text" id="createProductName" placeholder="ìƒí’ˆëª… ì…ë ¥">
<label for="createQuantity">ìˆ˜ëŸ‰: </label>
<input type="number" id="createQuantity" placeholder="ìˆ˜ëŸ‰ ì…ë ¥">
<button onclick="createData()">ğŸ†• ë°ì´í„° ìƒì„±</button>

<h2>ğŸ“Œ ë°ì´í„° ì¡°íšŒ</h2>
<label for="orderId">ID ì…ë ¥: </label>
<input type="text" id="orderId" placeholder="Order ID ì…ë ¥">
<button onclick="fetchData()">ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>

<h3>ìˆ˜ì •í•  ë°ì´í„° ì…ë ¥</h3>
<label for="updateOrderId">ID ì…ë ¥: </label>
<input type="text" id="updateOrderId" placeholder="Order ID ì…ë ¥">
<label for="updateProductName">ìƒí’ˆëª…: </label>
<input type="text" id="updateProductName" placeholder="ìˆ˜ì •í•  ìƒí’ˆëª…">
<label for="updateQuantity">ìˆ˜ëŸ‰: </label>
<input type="number" id="updateQuantity" placeholder="ìˆ˜ì •í•  ìˆ˜ëŸ‰">
<button onclick="updateData()">âœ ë°ì´í„° ìˆ˜ì •</button>

<p id="output">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
</body>
</html>
